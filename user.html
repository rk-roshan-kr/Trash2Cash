<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trash2Cash — User</title>

  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    /* Amazon-style modal */
    #modalOverlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
    }
    #modalBox {
      background:#fff;
      width:90%;
      max-width:420px;
      border-radius:12px;
      padding:16px;
      box-shadow:0 8px 30px rgba(0,0,0,0.25);
      z-index: 10;
    }
    .timeline-step {
      padding:8px 0;
      border-left:3px solid var(--brand);
      margin-left:12px;
      padding-left:12px;
      margin-bottom:8px;
    }
    #map { height:320px; border-radius:10px; z-index: 10; }
  </style>
</head>

<body>

<header class="topbar">
  <div class="brand">TRASH 2 CASH — User</div>
  <div style="padding-right:12px"><a id="logout" class="small">Logout</a></div>
</header>

<main class="page-area">
  <div id="error" class="error" style="display:none"></div>

  <!-- CREATE LISTING -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Create Trash Listing</h3>
      <div id="status" class="small"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <select id="type">
        <option value="P">Plastic</option>
        <option value="A">Paper</option>
        <option value="M">Metal</option>
        <option value="G">Glass</option>
        <option value="E">E-waste</option>
      </select>

      <input id="qty" placeholder="kg" style="width:90px"/>
      <input id="city" placeholder="City code" style="width:100px"/>
      <button id="create" class="primary">Create</button>
    </div>
  </div>

  <!-- WALLET -->
  <div class="card">
    <h3>Your Wallet</h3>
    <div id="wallet" class="small">Loading...</div>
  </div>

  <!-- LISTINGS -->
  <div class="card">
    <h3>Your Listings</h3>
    <div id="listings">Loading...</div>
  </div>

  <!-- MAP -->
  <div class="card">
    <h3>Map — Trucks</h3>
    <div id="map"></div>
  </div>
</main>

<!-- Amazon-style modal -->
<div id="modalOverlay">
  <div id="modalBox">
    <h3>Tracking Timeline</h3>
    <div id="modalBody"></div>
    <button class="primary" id="closeModal" style="margin-top:15px;width:100%">Close</button>
  </div>
</div>

<script type="module">
import common from './common.js';
const { 
  initApp, seedIfEmpty, onRealtimeCollection, 
  getUser, generateRefID, createTrash,
  fullStatusName, formatTimeline 
} = common;

initApp();

const userId = sessionStorage.getItem('t2c_id') || "user1";

/* Logout */
document.getElementById('logout').onclick = () => {
  sessionStorage.clear();
  location.href = "index.html";
};

const errBox = document.getElementById('error');
function showErr(msg){ errBox.style.display='block'; errBox.textContent=msg; }
function clearErr(){ errBox.style.display='none'; }

/* MAIN INIT */
(async function start(){
  try {
    await seedIfEmpty();
    const me = await getUser(userId);
    if(!me) showErr("User not found: "+userId);

    /* Wallet live */
    onRealtimeCollection("users", users=>{
      const u = users.find(x=>x.id===userId);
      document.getElementById("wallet").textContent =
        u ? "₹ " + (u.wallet||0).toFixed(2) : "₹ 0.00";
    });

    /* LISTINGS live */
    onRealtimeCollection("trash", all=>{
      const mine = all.filter(x=>x.owner===userId).sort((a,b)=> 
        (b.createdAt||"").localeCompare(a.createdAt||"")
      );

      document.getElementById("listings").innerHTML =
        mine.length
          ? mine.map(it=>`
          <div class="list-item">
            <b>${it.ref}</b> — ${it.type} — ${it.qty}kg — <b>${fullStatusName(it.status)}</b>
            <br>
            <button class="smalllink" onclick="window.showTimeline('${it.ref}')">Track Status</button>
          </div>
        `).join("")
          : `<div>No listings yet</div>`;
    });

    /* MAP LIVE */
    let map, markers = {};
    const L = window.L;

    function initMap(){
      map = L.map('map').setView([30.741, 76.768], 15);  // CU CAMPUS
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    }
    initMap();

    onRealtimeCollection("trucks", trucks=>{
      trucks.forEach(t=>{
        if(!markers[t.id]) {
          markers[t.id] = L.marker([t.lat, t.lon]).addTo(map).bindPopup(t.id);
        } else {
          markers[t.id].setLatLng([t.lat, t.lon]);
        }
      });
    });

    /* CREATE LISTING */
    document.getElementById("create").onclick = async ()=>{
      clearErr();
      let t = type.value;
      let q = parseFloat(qty.value) || 1;
      let c = (city.value || "D").toUpperCase();
      let ref = generateRefID(t,c);

      try {
        status.textContent = "Creating...";
        await createTrash(ref,{
          ref, owner:userId, type:t, qty:q, city:c,
          status:"PEN",
          timeline:[{code:"PEN", at:new Date().toISOString()}]
        });

        status.textContent = "Created "+ref;
        qty.value = ""; city.value = "";
        setTimeout(()=> status.textContent="",2000);
      }
      catch(e){
        showErr("Create failed: "+(e.message||e));
      }
    };

  } catch(e){
    showErr("Init failed: "+(e.message||e));
  }
})();

/* --- AMAZON STYLE MODAL --- */
window.showTimeline = function(refId){
  import('./common.js').then(mod=>{
    mod.getAll("trash").then(all=>{
      const obj = all.find(x=>x.id===refId);
      if(!obj) return;

      document.getElementById("modalBody").innerHTML = formatTimeline(obj.timeline);
      document.getElementById("modalOverlay").style.display = "flex";
    });
  });
};

document.getElementById("closeModal").onclick = ()=>{
  document.getElementById("modalOverlay").style.display = "none";
};
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
